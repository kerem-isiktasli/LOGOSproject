# 병목 탐지 모듈

> **최종 업데이트**: 2026-01-07
> **코드 위치**: `src/core/bottleneck.ts`
> **상태**: 활성
> **이론적 기초**: ALGORITHMIC-FOUNDATIONS.md 7부

---

## 맥락 및 목적

### 이 모듈이 존재하는 이유

병목 탐지 모듈은 다음에 답합니다: **"실제로 무엇이 나를 막고 있는가?"**

Maria를 생각해보세요: 어휘에서 85%, 절차 동사에서 30%. 이것은:
- 어휘 문제인가? (단어를 모름)
- 형태론 문제인가? (동사 형태를 처리할 수 없음)
- 통사 문제인가? (문장 구조에 어려움)

**병목 탐지기는 증상이 아닌 근본 원인을 찾습니다.**

---

## 계단식 모델

오류는 언어적 계층구조를 통해 전파됩니다:

```
PHON → MORPH → LEX → SYNT → PRAG
(음운) → (형태) → (어휘) → (통사) → (화용)
```

| 위치 | 구성요소 | 예시 |
|------|----------|------|
| 1 | PHON (음운론) | th-소리, 모음 |
| 2 | MORPH (형태론) | -ing, -ed 어미 |
| 3 | LEX (어휘) | 어휘 |
| 4 | SYNT (통사론) | 절, 어순 |
| 5 | PRAG (화용론) | 공손함, 사용역 |

**핵심 통찰**: 형태론 문제는 어휘, 통사, 화용 과제에서 오류로 나타납니다. 순진한 접근법은 높은 LEX 오류를 찾고 어휘 훈련을 처방합니다. 계단식을 인식하는 접근법은 MORPH로 추적합니다.

---

## 증거 수집

각 구성요소에 대해 다음을 수집합니다:

1. **오류율**: 오류 / 총 응답
2. **오류 패턴**: 유사성으로 클러스터링 (예: "-ed 어미 (7회)")
3. **공동 발생 오류**: 세션에서 함께 실패하는 구성요소
4. **개선 추세**: 첫 75% vs 마지막 25% 오류율

---

## 계단식 분석 알고리즘

```
계단식 순서의 각 구성요소에 대해 (PHON → PRAG):
    오류율 >= 임계값 (30%)이면:
        하류 구성요소도 상승함 (>= 20%)이면:
            → 이것이 근본 원인
            → 하류 오류는 계단식 효과
```

반환값:
- `rootCause`: 발생 구성요소
- `cascadeChain`: 영향받는 모든 구성요소
- `confidence`: 확신 정도 (0-1)

---

## 패턴 인식

오류는 유사성으로 클러스터링됩니다:

| 구성요소 | 패턴 예시 |
|----------|-----------|
| PHON | th-소리, r/l 구별, 모음 조합 |
| MORPH | -ing 어미, -ed 어미, 복수형 |
| LEX | 복잡한 어휘, 기본 어휘 |
| SYNT | 조건절, 관계절 |
| PRAG | 공손 표지, 사과 패턴 |

2회 이상 나타나는 패턴만 보고됩니다.

---

## 신뢰도 계산

신뢰도 = 데이터신뢰도 + 계단식부스트 + 차별화부스트

- **데이터 양**: min(1, 응답수 / 50)
- **계단식 탐지**: 계단식이 발견되면 +0.2
- **차별화**: min(0.2, 최고율 - 두번째율)

임계값:
- < 0.3: 더 많은 데이터 필요
- 0.3-0.5: 예비적
- 0.5-0.7: 보통
- > 0.7: 높은 신뢰도

---

## 실행 가능한 권장사항

생성된 권장사항에는 다음이 포함됩니다:
1. **초점 진술**: "형태론에 집중 (46% 오류율)"
2. **계단식 이점**: "이를 개선하면 어휘, 문법에도 도움이 됩니다"
3. **구체적 패턴**: "특히 연습: -ed 어미"
4. **추세 피드백**: "(이미 개선 중 - 계속하세요!)"

---

## 시각화: 계단식 오류 전파

```
오류율
     |
100% |
     |
 50% |  ****        병목 (MORPH)
     |  *  *
 30% |  *  *  ****  계단식 효과 (LEX)
     |  *  *  *  *
 20% |  *  *  *  *  ****  (SYNT)
     |  *  *  *  *  *  *
 10% |  *  *  *  *  *  *
     +---------------------------
       PHON MORPH LEX SYNT PRAG

진짜 원인: MORPH (형태론)
표면 증상: LEX, SYNT 오류
```

---

## 통합 지점

### 의존성
없음 - 순수 TypeScript.

### 의존처
- 세션 요약: `SessionSummary.bottlenecks`
- 분석 대시보드: 시각적 병목 표시
- 항목 선택: 병목 해결 항목 우선순위

---

## 사용 예시

```typescript
import { analyzeBottleneck, type ResponseData } from './bottleneck';

const analysis = analyzeBottleneck(responses);

console.log(analysis.primaryBottleneck);  // 'MORPH'
console.log(analysis.confidence);          // 0.75
console.log(analysis.recommendation);
// "형태론에 집중 (46% 오류율).
//  이를 개선하면 어휘에도 도움이 됩니다.
//  특히 연습: -ed 어미."
```

유틸리티 함수:
```typescript
getCascadePosition('MORPH');           // 1
canCauseErrors('MORPH', 'SYNT');       // true
getDownstreamComponents('MORPH');       // ['LEX', 'SYNT', 'PRAG']
summarizeBottleneck(analysis);          // "단어 형태 (46% 오류)"
```

---

*이 문서는 다음을 미러링합니다: `src/core/bottleneck.ts`*
